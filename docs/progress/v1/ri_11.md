# GitHub Issue #22 - 분석 및 해결 계획

**이슈**: [Test] 미커밋 문서 정리 + 테스트 커버리지 80% 달성
**생성일**: 2025-10-13
**상태**: OPEN
**분석일**: 2025-10-13

---

## Step 1: Issue Retrieval & Analysis

### Issue Information Summary
**이슈 번호**: #22
**제목**: [Test] 미커밋 문서 정리 + 테스트 커버리지 80% 달성
**상태**: OPEN
**생성일**: 2025-10-13T03:22:35Z
**담당자**: 미지정
**라벨**: 없음
**마일스톤**: 없음

### Issue Content Analysis
**문제 유형**: Test Coverage Enhancement + Documentation Cleanup
**우선순위**: High (프로덕션 준비도 95% → 98% 달성 목표)
**복잡도**: Medium (4-6시간 예상)

**핵심 요구사항**:
1. **Phase 0 (즉시)**: 미커밋 문서 정리 (`AGENTS.md`, `fb_8.md`, `fb_9.md`, `fb_10.md`)
2. **Phase 1 (30분)**: 현재 테스트 커버리지 측정 및 분석
3. **Phase 2 (3시간 전후)**: 커버리지 격차에 맞춘 테스트 보강 계획 수립 및 구현
4. **Phase 3 (1시간)**: 80% 커버리지 달성 검증 및 문서화

**기술적 제약사항**:
- Issue #20 (모니터링 + CI/CD) 완료가 전제조건
- 비동기 FastAPI 테스트 환경 필요
- Docker Compose Phase 2 CPU 환경 호환성 유지
- 기존 CI/CD 워크플로우와 통합 필요

---

## Step 2: Technical Investigation

### Code Analysis Required
**현재 상태 분석 결과**:

1. **미커밋 문서 상태**:
   - ✅ `AGENTS.md`: 존재 확인 (20줄, 리포지토리 가이드라인)
   - ⚠️ `fb_8.md`, `fb_9.md`, `fb_10.md`: **실제로 존재하지 않음**
   - 📄 `ri_10.md`에서 "fb_8.md, fb_9.md: 존재하지 않음" 명시

2. **기존 테스트 현황** (11개 파일, `def test_` 총 80개 확인):
   - `services/rag/tests/test_rag.py` (5개)
   - `services/embedding/tests/test_embedding.py` (7개)
   - `tests/integration/test_api_gateway.py` (4개)
   - `services/mcp-server/tests/test_rate_limiter.py` (11개)
   - `services/mcp-server/tests/test_approval_workflow.py` (8개)
   - `services/mcp-server/tests/integration/test_rbac_integration.py` (10개)
   - `services/mcp-server/tests/security/` (2개 파일, 총 18개)
   - `tests/memory/test_qdrant_failure.py` (7개)
   - `tests/test_memory_integration.py` (8개)
   - `scripts/test_importance_scoring.py` 등 스크립트 보조 테스트 (2개)

3. **pytest 환경**: 현재 호스트에 pytest 미설치 (Docker 내부에서 실행 필요)

**영향 범위 분석**:
- **Backend**: MCP Server, API Gateway, RAG, Embedding 서비스
- **Infrastructure**: Docker Compose Phase 2 CPU 환경
- **CI/CD**: GitHub Actions 워크플로우 (`.github/workflows/ci.yml`)

### Dependency Check
**의존성 이슈**:
- ✅ Depends on: #20 - 모니터링 + CI/CD 구축 완료 (완료됨, PR #21 병합)
- 🔗 Related to: #18 - RBAC 운영 준비 (10개 통합 테스트 참고)
- 🔗 Related to: #8 - RBAC 시스템 구현 (테스트 대상)

---

## Step 3: Solution Strategy

### Approach Options

**Option 1: 단계별 수동 테스트 작성 (이슈 원안)**
- **장점**: 세밀한 테스트 제어, 높은 커버리지 가능
- **단점**: 4-6시간 소요, 수동 작업 부담
- **예상 시간**: 4-6시간
- **위험도**: Medium (비동기 테스트 복잡도)

**Option 2: AI 자동 테스트 생성 도구 활용**
- **장점**: 빠른 기본 테스트 생성 (1-2시간)
- **단점**: 품질 보장 어려움, 추가 검증 필요
- **예상 시간**: 2-3시간
- **위험도**: High (테스트 품질 불확실)

**Option 3: 핵심 경로 우선 + 점진적 확장**
- **장점**: 빠르게 커버리지 격차 파악 후 우선순위 서비스(예: MCP, API Gateway)에 집중 가능
- **단점**: 엣지 케이스는 후속 이슈로 이월될 수 있음
- **예상 시간**: 3-4시간
- **위험도**: Low (기존 패턴 재사용 + 데이터 기반 의사결정)

### Recommended Approach
**선택한 접근법**: **Option 3** - 핵심 경로 우선 + 점진적 확장
**선택 이유**:
1. 기존 테스트 패턴 (`test_rbac_integration.py`) 재사용 가능
2. MCP Server RBAC 및 API Gateway 라우팅이 최우선 (CLAUDE.md 기준)
3. 80% 목표 달성 후 나머지는 후속 이슈로 분리 가능
4. 현실적인 시간 내 완료 가능 (5시간 내외)

---

## Step 4: Detailed Implementation Plan

### Phase 0: 문서 정리 (15분)
**목표**: Git 작업 트리 클린 상태 유지

| Task | Description | Owner | DoD | Risk |
|------|-------------|-------|-----|------|
| 0.1 AGENTS.md 검토 | 내용 확인 및 커밋 여부 결정 | 개발자 | 파일 검토 완료 | Low |
| 0.2 fb_*.md 확인 | 실제 존재 여부 재확인 | 개발자 | `git status` 클린 | Low |
| 0.3 Git 커밋 | `docs: add repository guidelines (AGENTS.md)` | 개발자 | 커밋 완료 | Low |

**실행 계획**:
```bash
# AGENTS.md 내용 검토 완료 (리포지토리 가이드라인)
git add AGENTS.md
git commit -m "docs: add repository guidelines for code standards and testing"

# fb_8/9/10.md는 실제로 존재하지 않음 (이슈 설명 오류)
git status  # 확인: clean
```

### Phase 1: 커버리지 측정 (30분)
**목표**: 테스트 부족 영역 식별

| Task | Description | Owner | DoD | Risk |
|------|-------------|-------|-----|------|
| 1.1 Docker 환경 시작 | Phase 2 CPU 스택 실행 | 개발자 | 모든 컨테이너 healthy | Low |
| 1.2 전체 커버리지 측정 | pytest-cov로 현재 상태 파악 | 개발자 | 커버리지 리포트 생성 | Low |
| 1.3 서비스별 분석 | MCP, API Gateway, RAG, Embedding별 분석 | 개발자 | 우선순위 리스트 작성 | Low |

**실행 계획**:
```bash
# Docker 환경 시작
docker compose -f docker/compose.p2.cpu.yml up -d

# 커버리지 측정 (컨테이너 내부)
docker exec -it <rag-container> pytest --cov=. --cov-report=term-missing --cov-report=html
docker exec -it <embedding-container> pytest --cov=. --cov-report=term-missing

# 또는 호스트에서 pytest 설치 후
pip install pytest pytest-cov pytest-asyncio httpx
pytest --cov=services --cov-report=term-missing --cov-report=html
```

### Phase 2: 테스트 코드 작성 (3-4시간)
**목표**: 커버리지 레포트 기반으로 취약 영역 보강

| Task | Description | Owner | DoD | Risk |
|------|-------------|-------|-----|------|
| 2.1 MCP Server 테스트 확장 | RBAC 미들웨어・도구 실행 플로우 보강 | 개발자 | 커버리지 미달 함수 추가 검증 | Medium |
| 2.2 API Gateway 테스트 확장 | 라우팅·페일오버·헬스 점검 케이스 작성 | 개발자 | 주요 라우트 100% 브랜치 커버 | Medium |
| 2.3 RAG 테스트 확장 | 질의/인덱싱 오류 경로 포함 | 개발자 | 실패 시나리오 검증 | Low |
| 2.4 Embedding 테스트 확장 | 배치·예외 처리 강화 | 개발자 | 경계 입력 처리 확인 | Low |
| 2.5 통합 테스트 추가 | 서비스 간 연동 정상/이상 흐름 확인 | 개발자 | 크리티컬 플로우 3종 검증 | Medium |

**테스트 후보 상세** (커버리지 결과에 따라 조정):

**MCP Server**:
```python
# services/mcp-server/tests/test_rbac_middleware.py (신규)
- test_rbac_middleware_allows_admin_all_tools()
- test_rbac_middleware_blocks_user_high_risk_tool()
- test_rbac_middleware_rate_limit_exceeded()
- test_rbac_audit_log_creation()
- test_rbac_permission_denied_403()
- test_rbac_approval_required_pending()
- test_rbac_token_validation_failure()
- test_rbac_role_hierarchy_enforcement()

# services/mcp-server/tests/test_tool_execution.py (신규)
- test_git_diff_success()
- test_read_file_permission_check()
- test_run_command_sandbox_escape_blocked()
- test_notion_create_page_with_approval()
- test_tool_execution_timeout()
```

**API Gateway**:
```python
# services/api-gateway/tests/test_routing.py (신규)
- test_chat_model_routing()
- test_code_model_routing()
- test_model_selection_fallback()
- test_invalid_model_name_400()

# services/api-gateway/tests/test_failover.py (신규)
- test_primary_failure_fallback_to_secondary()
- test_both_servers_down_503()
- test_failover_retry_mechanism()

# services/api-gateway/tests/test_health.py (신규)
- test_health_endpoint_all_dependencies_up()
- test_health_endpoint_inference_down()
- test_health_endpoint_timeout_handling()
```

**RAG**:
```python
# services/rag/tests/test_rag.py (기존 확장)
- test_query_with_empty_collection()
- test_query_timeout_handling()
- test_index_large_document_batch()
- test_index_invalid_format()
- test_qdrant_connection_retry()
```

**Embedding**:
```python
# services/embedding/tests/test_embedding.py (기존 확장)
- test_batch_embedding_over_limit()
- test_embedding_timeout_error()
- test_embedding_invalid_input_format()
```

**Integration**:
```python
# tests/integration/test_service_communication.py (신규)
- test_rag_to_embedding_pipeline()
- test_api_gateway_to_inference_flow()
- test_mcp_to_rag_query_flow()
```

### Phase 3: 검증 및 문서화 (1시간)
**목표**: 커버리지 80% 달성 확인 및 문서화

| Task | Description | Owner | DoD | Risk |
|------|-------------|-------|-----|------|
| 3.1 로컬 테스트 실행 | pytest + 커버리지 레포트 재생성 | 개발자 | 80% 이상 달성 | Low |
| 3.2 CI 테스트 검증 | GitHub Actions 워크플로우 실행 | 개발자 | CI 통과 | Medium |
| 3.3 CLAUDE.md 업데이트 | 커버리지 결과 반영 | 개발자 | 문서 업데이트 완료 | Low |
| 3.4 Git 커밋 및 PR | 모든 변경사항 커밋 | 개발자 | PR 생성 완료 | Low |

**실행 계획**:
```bash
# 로컬 테스트 실행
pytest --cov=services --cov-report=term-missing --cov-report=html

# 커버리지 확인 (WSL)
wslview htmlcov/index.html

# CI 테스트 (선택적)
git push origin issue-22
# GitHub Actions 자동 실행 확인

# 문서 업데이트
# CLAUDE.md의 "테스트 커버리지" 섹션 수정
git add CLAUDE.md services/ tests/ .github/
git commit -m "test: expand coverage to 80% for issue-22"
```

---

## Step 5: Risk Assessment & Mitigation

### High Risk Items
| Risk | Impact | Probability | Mitigation Strategy |
|------|--------|-------------|-------------------|
| 현재 커버리지가 50% 미만 | High | Medium | 목표를 70%로 조정, 핵심 경로만 우선 테스트 |
| 비동기 테스트 작성 복잡도 | Medium | Medium | 기존 `test_rbac_integration.py` 패턴 재사용 |
| CI 환경에서 테스트 실패 | High | Low | 로컬 Docker 환경에서 사전 검증, Mock 사용 |
| 테스트 작성 시간 초과 | Medium | High | 핵심 서비스 우선, 나머지는 후속 이슈로 분리 |

### Technical Challenges
**예상 기술적 난점**:
1. **비동기 FastAPI 테스트** - `pytest-asyncio` + `httpx.AsyncClient` fixture 활용
2. **Docker 내부 pytest 실행** - 컨테이너 환경에서 테스트 실행 필요
3. **Mock Inference 연동** - `docker/compose.p2.cpu.yml`의 mock-inference 활용

### Rollback Plan
**롤백 시나리오**:
- **커버리지 80% 미달성** → 목표를 70%로 조정하고 핵심 경로만 테스트
- **CI 테스트 실패** → 로컬 검증 후 GitHub Actions 워크플로우 수정
- **AGENTS.md 커밋 오류** → `git reset HEAD~1`로 롤백 후 재검토

---

## Step 6: Resource Requirements

### Human Resources
- **개발자**: 1명 (Python, FastAPI, pytest 경험 필수)
- **리뷰어**: 1명 (테스트 코드 품질 검토)
- **QA**: 불필요 (자동화 테스트)

### Technical Resources
- **개발 도구**: pytest, pytest-cov, pytest-asyncio, httpx
- **테스트 환경**: Docker Compose Phase 2 CPU (mock-inference)
- **모니터링**: GitHub Actions CI 워크플로우

### Time Estimation
- **Phase 0**: 15분 (문서 정리)
- **Phase 1**: 30분 (커버리지 측정)
- **Phase 2**: 3-4시간 (테스트 작성)
- **Phase 3**: 1시간 (검증 및 문서화)
- **총 예상 시간**: 5시간 내외
- **버퍼 시간**: 1시간 (20%, 총 6시간 확보)
- **완료 목표일**: 2025-10-13 (당일 완료 가능)

---

## Step 7: Quality Assurance Plan

### Test Strategy
**테스트 레벨**:
- **Unit Tests**: 개별 함수/클래스 테스트 (MCP 도구, RBAC 미들웨어)
- **Integration Tests**: 서비스 간 통신 검증 (RAG ↔ Embedding, API Gateway ↔ Inference)
- **E2E Tests**: 사용자 시나리오 (AI CLI → API Gateway → Inference)

### Test Cases
```gherkin
Feature: MCP Server RBAC 미들웨어

  Scenario: Admin 사용자가 HIGH 위험도 도구 실행
    Given Admin 역할의 인증 토큰
    When run_command 도구를 실행
    Then 200 OK 응답과 명령 결과 반환

  Scenario: User 사용자가 HIGH 위험도 도구 실행
    Given User 역할의 인증 토큰
    When run_command 도구를 실행
    Then 403 Forbidden 응답과 권한 거부 메시지

Feature: API Gateway 페일오버

  Scenario: Primary inference 서버 다운 시 Fallback
    Given Primary inference 서버가 다운 상태
    When /v1/chat/completions 요청
    Then Secondary inference 서버로 라우팅되어 200 OK 응답
```

### Performance Criteria
- **테스트 실행 시간**: 전체 테스트 5분 이내
- **커버리지**: 전체 80% 이상, 핵심 서비스 85% 이상
- **CI 실행 시간**: GitHub Actions 10분 이내

---

## Step 8: Communication Plan

### Status Updates
- **일일 스탠드업**: 진행 상황 공유 (Phase별 완료 상태)
- **이슈 댓글 업데이트**: Phase 완료마다 체크박스 업데이트
- **슬랙/팀즈 채널**: 실시간 소통 (선택적)

### Stakeholder Notification
- **프로젝트 매니저**: 4시간 내 완료 예정 안내
- **관련 팀**: 테스트 커버리지 80% 달성 시 공유
- **사용자/고객**: 해당 없음 (내부 품질 개선)

---

## 📋 User Review Checklist

### Planning Review
- [x] **이슈 분석이 정확한가요?**
  - ✅ 핵심 요구사항 4개 Phase 모두 파악
  - ⚠️ fb_8/9/10.md는 실제로 존재하지 않음 (이슈 설명 오류)
  - ✅ 기술적 제약사항 (비동기 테스트, Docker 환경) 파악

- [x] **선택한 해결 방안이 적절한가요?**
  - ✅ Option 3 (핵심 경로 우선) 선택 - 현실적이고 검증된 접근법
  - ✅ 기존 RBAC 테스트 패턴 재사용으로 위험 최소화
  - ✅ 80% 목표 달성 후 나머지는 후속 이슈 분리 가능

- [x] **구현 계획이 현실적인가요?**
  - ✅ 각 Phase별 작업량 적절 (15분, 30분, 2-3시간, 1시간)
  - ✅ 의존성 명확 (Phase 0 → 1 → 2 → 3 순서)
  - ⚠️ Phase 2 테스트 작성이 예상보다 오래 걸릴 수 있음 (버퍼 1시간 확보)

### Resource Review
- [x] **시간 추정이 합리적인가요?**
  - ✅ 총 4시간 + 버퍼 1시간 = 5시간 (당일 완료 가능)
  - ✅ Phase 2가 가장 시간 소요 (2-3시간)

- [x] **필요한 리소스가 확보 가능한가요?**
  - ✅ Docker Compose Phase 2 CPU 환경 이미 구축됨
  - ✅ pytest, pytest-cov 설치 가능
  - ✅ 기존 테스트 패턴 재사용 가능

### Risk Review
- [x] **위험 요소가 충분히 식별되었나요?**
  - ✅ 4개 주요 위험 식별 (커버리지 부족, 비동기 복잡도, CI 실패, 시간 초과)
  - ✅ 각 위험에 대한 구체적 대응 방안 있음

- [x] **롤백 계획이 현실적인가요?**
  - ✅ 목표 조정 (80% → 70%), Git 롤백 가능

### Quality Review
- [x] **테스트 전략이 충분한가요?**
  - ✅ Unit/Integration/E2E 3단계 테스트 전략
  - ✅ 핵심 시나리오 (RBAC, 페일오버) 커버
  - ⚠️ 성능/보안 테스트는 추가 고려 필요 (후속 이슈)

---

## 🚀 Next Steps

**진행 권장사항**:

### ✅ 즉시 시작 가능 항목
1. **Phase 0**: AGENTS.md 커밋 (15분)
2. **Phase 1**: 현재 커버리지 측정 (30분)

### ⚠️ 수정 권장사항
1. **fb_8/9/10.md 제거**: 이슈 설명에서 삭제 (실제로 존재하지 않음)
2. **Phase 2 시간 조정**: 3-4시간 기준으로 재산정 (비동기 테스트 복잡도 고려)
3. **테스트 우선순위 재확인**: MCP Server RBAC > API Gateway 페일오버 > RAG/Embedding
4. **실측 데이터 기반 목표 재확인**: 초기 테스트 수(약 80개)를 기준으로 커버리지 격차 분석

### 📌 Immediate Action Plan
1. **커버리지 측정 실행**  
   - 명령: `pytest --cov=services --cov-report=term-missing --cov-report=html`  
   - 산출물: `htmlcov/index.html` 커버리지 리포트, 미달 함수 목록 정리
2. **테스트 우선순위 확정**  
   - 커버리지 리포트에서 미달 영역을 MCP Server → API Gateway → RAG → Embedding 순으로 정렬  
   - Phase 2 표의 테스트 후보 목록과 매칭하여 실제 구현 범위 결정
3. **이슈 설명 정정**  
   - GitHub Issue #22에서 존재하지 않는 `fb_8/9/10.md` 요구사항을 제거하거나 수정 요청
4. **Phase 2 상세 일정 수립**  
   - 보강이 필요한 함수/브랜치별 예상 테스트 수 메모  
   - 비동기 테스트는 기존 `services/mcp-server/tests/integration/test_rbac_integration.py` 패턴을 참고해 fixture 재사용 계획 수립
5. **Phase 3 검증 준비**  
   - 커버리지 갱신 후 `CLAUDE.md`의 테스트 커버리지 섹션 업데이트 초안 작성  
   - 필요 시 CI 로그 캡처 또는 링크 확보

### 🔄 실행 체크리스트 (순차 진행)
1. `make up-p2` 또는 `docker compose -f docker/compose.p2.cpu.yml up -d`로 Phase 2 스택 기동  
2. `pytest --cov=services --cov-report=term-missing --cov-report=html` 실행, `htmlcov/index.html` 확인  
3. 커버리지 미달 함수 목록을 표로 정리하고 Phase 2 테스트 후보와 1:1 매칭  
4. MCP Server 테스트부터 순차 구현 (`services/mcp-server/tests/…` 경로에 신규 파일 추가)  
5. API Gateway, RAG, Embedding, 통합 테스트 순으로 보강 후 `pytest -q` 재실행  
6. 커버리지 80% 이상 확인, `CLAUDE.md` 테스트 커버리지 섹션 업데이트  
7. Issue #22에 정리 내용 댓글 + `fb_8/9/10.md` 요구사항 정정  
8. `git status`로 변경 파일 확인, 적절히 커밋 (`test:`/`docs:` prefix) 후 PR 생성 준비

### 📝 검토 후 진행
- [x] 계획 검토 완료
- [ ] Phase 0 시작 (AGENTS.md 커밋)
- [ ] Phase 1 시작 (커버리지 측정)
- [ ] Phase 2 시작 (테스트 작성)
- [ ] Phase 3 시작 (검증 및 PR)

---

## 💡 피드백 요청

**질문 사항**:
1. **fb_8/9/10.md**: 이슈에 명시되어 있으나 실제로 존재하지 않습니다. 이슈 설명을 업데이트할까요?
2. **테스트 우선순위**: MCP Server RBAC와 API Gateway 페일오버 중 어느 것을 먼저 작성할까요?
3. **커버리지 목표**: 현재 커버리지를 측정하기 전에 목표를 80%로 고정할까요, 아니면 측정 후 조정할까요?
4. **후속 작업**: 80% 달성 후 E2E 테스트나 성능 테스트를 별도 이슈로 분리할까요?

---

## 📊 Progress Tracking

### Phase 0: 문서 정리
- [ ] AGENTS.md 검토 및 커밋
- [ ] fb_*.md 존재 여부 확인
- [ ] Git 상태 클린 확인

### Phase 1: 커버리지 측정
- [ ] Docker 환경 시작
- [ ] 전체 커버리지 측정
- [ ] 서비스별 분석 완료

### Phase 2: 테스트 작성
- [ ] MCP Server 커버리지 미달 함수 테스트 보강
- [ ] API Gateway 주요 플로우 테스트 보강
- [ ] RAG 실패/경계 시나리오 테스트 보강
- [ ] Embedding 예외 처리 테스트 보강
- [ ] 통합 플로우 검증 테스트 추가

### Phase 3: 검증 및 문서화
- [ ] 로컬 테스트 실행 (80% 달성)
- [ ] CI 테스트 검증
- [ ] CLAUDE.md 업데이트
- [ ] Git 커밋 및 PR 생성

---

**문서 작성일**: 2025-10-13
**작성자**: Claude Code (/resolve-issue 명령)
**관련 이슈**: #22
**관련 PR**: TBD
