# Issue #38: Approval Workflow Production Verification (V1-V7)

**작성일**: 2025-10-23
**상태**: Ready to Execute
**예상 시간**: 3-4시간

---

## 📋 Issue 분석 결과

### 🎯 핵심 정보

| 항목 | 내용 |
|------|------|
| **제목** | [Test] Approval Workflow Production Verification (V1-V7) |
| **상태** | OPEN |
| **예상 시간** | 3-4시간 |
| **생성일** | 2025-10-23 |
| **우선순위** | Medium (검증 작업) |
| **기본 문서** | docs/progress/v1/fb_19.md |

### 📌 작업 내용

이것은 **Issue #26** (승인 워크플로우 UX)와 **Issue #36** (검증 & 개선)를 완료한 후, 실제 프로덕션 환경에서 최종 검증을 하는 작업입니다.

**Background**:
- Issue #36 (PR #37) 완료: `seconds_until_expiry` 필드 수정
- 승인 워크플로우 백엔드 경로는 구현 완료했으나, CLI·대시보드 승인 처리 로직(`scripts/ai.py`, 승인 요청 UI)과 문서 동기화 작업이 남아 있음
- 프로덕션 검증 테스트(V1-V7) 미실행 상태 (선행 조건 제거 후 실행 가능)

**Goal**:
- 실제 프로덕션 환경에서 승인 워크플로우 동작 검증
- 모든 시나리오(승인/거부/타임아웃) 정상 동작 확인
- 문서에 검증 완료 상태 기록

---

## ✅ 완료 조건 (DoD)

### Phase 0: 선행 조건 확인 (필수)
- [x] CLI·대시보드 승인 요청 UX 연결 (부분 완료: ai.py handle_approval_workflow() 구현 완료)
  - ⚠️ **미해결**: scripts/ai.py에서 MCP 호출 시 X-User-ID 헤더 미전달 (rbac_middleware.py:119 요구)
  - **해결 계획**: scripts/ai.py:103 call_mcp_tool()에 X-User-ID 헤더 추가, argparse에 --mcp-user 인자 추가
- [x] `scripts/ai.py`, `scripts/approval_cli.py`에 승인 처리 로직 반영
  - ✅ ai.py: handle_approval_workflow(), wait_for_approval_simple() 함수 구현됨
  - ✅ approval_cli.py: approve_request(), reject_request() 함수 구현됨
  - ⚠️ **미해결**: approval_cli.py에서도 X-User-ID 헤더 지원 필요
- [ ] `docs/security/IMPLEMENTATION_SUMMARY.md`에 `APPROVAL_WORKFLOW_ENABLED` 기본값과 운영 절차 업데이트
- [ ] 승인 기능 관련 CI 검증 루틴/pytest 스크립트 준비 (`make up-p2` 컨테이너 기준)

**Phase 0 진행 상황**: 50% (UI 로직 완료, 헤더 통합 필요)

### Phase 1: 환경 설정 (30분)
- [ ] 로그 디렉토리 생성
- [ ] 환경 변수 설정 (`APPROVAL_WORKFLOW_ENABLED=true`)
- [ ] Phase 3 스택 기동 (`make up-p3`)
- [ ] MCP 서버 헬스 체크
- [ ] Security DB 확인 (4명 사용자)

### Phase 2: V1-V7 검증 시나리오 (2시간)
- [ ] V1: Production stack startup (이미 P1에서 완료)
- [ ] V2: HIGH tool approval (write_file)
- [ ] V3: CRITICAL tool approval (execute_python)
- [ ] V4: Rejection flow (execute_bash)
- [ ] V5: Timeout scenario (git_commit)
- [ ] V6: Concurrent approvals (optional)
- [ ] V7: Audit log verification

### Phase 3: 프로덕션 준비 체크리스트 (1-1.5시간)
- [ ] 환경 변수 확인
- [ ] DB 시딩 확인
- [ ] 서비스 헬스 확인
- [ ] 스모크 테스트

### Phase 4: 정리 & 문서화 (15분)
- [ ] Docker 스택 중지
- [ ] 검증 로그 커밋
- [ ] CLAUDE.md 업데이트
- [ ] VERIFICATION_SUMMARY.md 생성
- [ ] Git commit 완료

---

## 📊 구현 계획 요약

### 전체 단계

```
Phase 1: 환경 설정        → docker/python/sqlite 확인 (30분)
  ├─ P1-T1: 로그 디렉터리 생성
  ├─ P1-T2: 환경 변수 설정
  ├─ P1-T3: Phase 3 스택 기동
  ├─ P1-T4: MCP 서버 헬스 체크
  └─ P1-T5: Security DB 확인

Phase 2: V1-V7 실행       → 승인/거부/타임아웃 시나리오 (2시간)
  ├─ V2: HIGH 도구 승인 (write_file)
  ├─ V3: CRITICAL 도구 승인 (execute_python)
  ├─ V4: 거부 플로우 (execute_bash)
  ├─ V5: 타임아웃 시나리오 (git_commit)
  ├─ V6: 동시 승인 (선택)
  └─ V7: 감사 로그 검증

Phase 3: 검증 체크리스트  → 환경 변수, DB, 헬스 체크 (1-1.5시간)
  ├─ 환경 변수 확인
  ├─ DB 시딩 확인
  ├─ 서비스 헬스 확인
  └─ 스모크 테스트

Phase 4: 커밋 & 정리      → 로그 저장, 문서 업데이트 (15분)
  ├─ Docker 스택 중지
  ├─ 검증 로그 커밋
  ├─ 문서 업데이트
  └─ Git commit
```

---

## 🚀 추천 접근법

### 현재 상태

Phase 3 스택(MCP + RBAC + 감사 로깅)은 준비되어 있으므로, **Phase 0 선행 조건 충족 후 즉시 검증 실행 가능**합니다.

### 선택 옵션

| 옵션 | 내용 | 예상 시간 | 위험도 |
|------|------|----------|--------|
| **Option A** | 지금 바로 모든 검증 실행 (V1-V7) | 3-4시간 | Low |
| **Option B** | 계획 검토 후 실행 | 3.5-4.5시간 | Low |
| **Option C** | 필수 시나리오만 선택 실행 (V2,V3,V4,V7) | 2-2.5시간 | Low |

> ※ 모든 옵션은 Phase 0 선행 조건(승인 UX 연결, 문서/CI 업데이트) 완료를 전제로 합니다.

### 권장 순서

0. **Phase 0**: 선행 조건 충족 (30-45분, CLI/문서 동기화 후 테스트)
1. **Phase 1**: 빠르게 환경 설정 (30분, 자동 실행 가능)
2. **Phase 2**: 각 시나리오 순차 실행 (2시간, 수동 개입 필요)
3. **Phase 3**: 체크리스트 자동화 (1-1.5시간, 대부분 자동)
4. **Phase 4**: 정리 및 커밋 (15분, 자동 실행 가능)

---

## 📝 Phase 2 상세 시나리오

### V2: HIGH Tool Approval (write_file)

**목표**: HIGH 권한 도구의 승인 플로우 검증

**Terminal 1 (User)**:
```bash
python scripts/ai.py --mcp write_file --mcp-args '{\"file_path\": \"./test_v2.txt\", \"content\": \"V2 approval test\"}' 2>&1 | tee logs/approval_workflow/v2_user_request.log
```

**Terminal 2 (Admin)**:
```bash
python scripts/approval_cli.py --list-only 2>&1 | tee logs/approval_workflow/v2_admin_list.log
REQUEST_ID=$(sqlite3 /mnt/e/ai-data/sqlite/security.db "SELECT request_id FROM approval_requests WHERE status='pending' ORDER BY requested_at DESC LIMIT 1;")
python scripts/approval_cli.py 2>&1 | tee logs/approval_workflow/v2_admin_approve.log
# Interactive: Approve with reason "V2 test - Authorized by security team"
```

**성공 기준**:
- [ ] User CLI shows progress bar
- [ ] Admin CLI lists pending request
- [ ] Approval succeeds
- [ ] File `test_v2.txt` created
- [ ] Audit log records event

---

### V3: CRITICAL Tool Approval (execute_python)

**목표**: CRITICAL 권한 도구의 승인 플로우 검증

**Terminal 1 (User)**:
```bash
python scripts/ai.py --mcp execute_python --mcp-args '{\"code\": \"print(\\\"V3 test: 2+2=\\\", 2+2)\", \"timeout\": 30}' 2>&1 | tee logs/approval_workflow/v3_user_request.log
```

**Terminal 2 (Admin)**:
```bash
python scripts/approval_cli.py --list-only 2>&1 | tee logs/approval_workflow/v3_admin_list.log
python scripts/approval_cli.py 2>&1 | tee logs/approval_workflow/v3_admin_approve.log
# Reason: "V3 test - CRITICAL tool authorized"
```

**성공 기준**:
- [ ] Progress bar with 300s timeout
- [ ] Python code executes: "V3 test: 2+2= 4"
- [ ] Audit log records CRITICAL tool approval

---

### V4: Rejection Flow (execute_bash)

**목표**: 승인 거부 플로우 검증

**Terminal 1 (User)**:
```bash
python scripts/ai.py --mcp execute_bash --mcp-args '{\"command\": \"echo V4 rejection test\"}' 2>&1 | tee logs/approval_workflow/v4_user_request.log
```

**Terminal 2 (Admin)**:
```bash
python scripts/approval_cli.py --list-only 2>&1 | tee logs/approval_workflow/v4_admin_list.log
python scripts/approval_cli.py 2>&1 | tee logs/approval_workflow/v4_admin_reject.log
# Choose "Reject", Reason: "V4 test - Unapproved shell access"
```

**성공 기준**:
- [ ] Terminal 1 shows "❌ Approval rejected"
- [ ] Rejection reason displayed
- [ ] No command execution
- [ ] DB status = 'rejected'

---

### V5: Timeout Scenario (git_commit)

**목표**: 승인 타임아웃 시나리오 검증

**권장**: Simulated Timeout (빠름)

```bash
# Simulated timeout
python scripts/ai.py --mcp git_commit --mcp-args '{\"message\": \"V5 timeout simulation\"}' &
sleep 5
REQUEST_ID=$(sqlite3 /mnt/e/ai-data/sqlite/security.db "SELECT request_id FROM approval_requests WHERE status='pending' ORDER BY requested_at DESC LIMIT 1;")
sqlite3 /mnt/e/ai-data/sqlite/security.db "UPDATE approval_requests SET status='timeout', responded_at=datetime('now') WHERE request_id='$REQUEST_ID';"
sleep 2
pkill -f "scripts/ai.py"
sqlite3 /mnt/e/ai-data/sqlite/security.db "SELECT status, expires_at FROM approval_requests WHERE request_id='$REQUEST_ID';" | tee logs/approval_workflow/v5_db_timeout.log
```

**성공 기준**:
- [ ] DB status = 'timeout'
- [ ] No tool execution

---

### V6: Concurrent Approvals (Optional)

**목표**: 동시 승인 요청 처리 검증

```bash
python scripts/ai.py --mcp write_file --mcp-args '{\"file_path\": \"./v6_userA.txt\", \"content\": \"User A\"}' &
python scripts/ai.py --mcp write_file --mcp-args '{\"file_path\": \"./v6_userB.txt\", \"content\": \"User B\"}' &
python scripts/approval_cli.py --list-only | tee logs/approval_workflow/v6_admin_list.log
```

**성공 기준**:
- [ ] Admin CLI shows 2 pending requests
- [ ] Both requests approved sequentially
- [ ] Both files created

---

### V7: Audit Log Verification

**목표**: 모든 승인 워크플로우 이벤트가 감사 로그에 기록되었는지 검증

```bash
# Count approval events
sqlite3 /mnt/e/ai-data/sqlite/security.db "SELECT COUNT(*) FROM security_audit_logs WHERE action LIKE 'approval_%';" | tee logs/approval_workflow/v7_count.log

# List recent approval activity
sqlite3 /mnt/e/ai-data/sqlite/security.db "
SELECT timestamp, user_id, tool_name, action, status
FROM security_audit_logs
WHERE tool_name IN ('write_file', 'execute_python', 'execute_bash', 'git_commit')
ORDER BY timestamp DESC
LIMIT 20;
" | tee logs/approval_workflow/v7_recent_activity.log

# Check approval_requests table
sqlite3 /mnt/e/ai-data/sqlite/security.db "
SELECT request_id, tool_name, user_id, status, requested_at, responded_at, response_reason
FROM approval_requests
ORDER BY requested_at DESC
LIMIT 10;
" | tee logs/approval_workflow/v7_approval_requests.log
```

**성공 기준**:
- [ ] All V2-V5 events present in audit logs
- [ ] Each event has correct status
- [ ] Timestamps sequential
- [ ] User IDs match test scenarios

---

## 🎬 빠른 시작 가이드

### 0단계: Phase 0 선행 조건 점검

```bash
# 승인 CLI 경로 점검 (요청 → 승인/거부 → 피드백)
python scripts/ai.py --mcp-list
python scripts/approval_cli.py --list-only

# 승인 워크플로우 환경 변수/문서 정합성 확인
rg "APPROVAL_WORKFLOW_ENABLED" -n docs/security/IMPLEMENTATION_SUMMARY.md
pytest services/mcp-server/tests/test_approval_workflow.py -q  # 컨테이너 내부 실행 권장
```

### 1단계: Phase 1 설정 실행

```bash
# 로그 디렉터리 생성
mkdir -p logs/approval_workflow

# 환경 변수 설정
export APPROVAL_WORKFLOW_ENABLED=true

# Phase 3 스택 기동
make up-p3

# 대기 (2분)
sleep 120

# 헬스 체크
curl http://localhost:8020/health | tee logs/approval_workflow/p1_health_mcp.log
curl http://localhost:8020/security/health | tee logs/approval_workflow/p1_health_security.log

# DB 사용자 확인
sqlite3 /mnt/e/ai-data/sqlite/security.db "SELECT user_id, username FROM security_users;" | tee logs/approval_workflow/p1_db_users.log
```

### 2단계: Phase 2 시나리오 실행

각 시나리오별로 위의 명령어를 순차적으로 실행합니다.

```bash
# V2: write_file 승인
# V3: execute_python 승인
# V4: execute_bash 거부
# V5: git_commit 타임아웃
# V7: 감사 로그 검증
```

### 3단계: Phase 3 체크리스트

```bash
# 환경 변수 확인
grep APPROVAL_WORKFLOW_ENABLED .env

# DB 시딩 확인
sqlite3 /mnt/e/ai-data/sqlite/security.db "SELECT COUNT(*) FROM security_users;"

# 서비스 헬스
curl http://localhost:8020/health | jq
```

### 4단계: 정리 & 커밋

```bash
# 스택 중지
make down

# 로그 및 문서 커밋 (fb_19 계획과 동기화)
git add logs/approval_workflow/
git add docs/progress/v1/fb_19.md
git commit -m "docs: Complete approval workflow verification (V1-V7)"
```

---

## 🚨 주요 위험 및 대응

| 위험 | 확률 | 영향 | 대응 방안 |
|------|------|------|---------|
| Docker 환경 문제 | Low | High | Pre-flight health check 추가 |
| Timeout 테스트 시간 소요 | High | Low | Simulated timeout option 제공 |
| DB 권한 문제 | Low | Medium | 사전에 sqlite3 접근 확인 |
| 로그 경로 누락 | Medium | Low | Phase 1에서 디렉터리 생성 |
| 동시 실행 충돌 | Low | Low | 순차 실행 권장 |

---

## 📚 참고 자료

### 관련 문서
- 상세 실행 계획: `docs/progress/v1/fb_19.md`
- 검증 가이드: `docs/progress/v1/fb_18.md`
- 구현 요약: `docs/security/IMPLEMENTATION_SUMMARY.md`
- 운영 가이드: `docs/security/RBAC_GUIDE.md`

### 관련 이슈
- Issue #26: Approval workflow UX
- Issue #36: Verification & remediation (completed, PR #37)
- Issue #8: RBAC system
- Issue #16: Approval workflow

### 필수 도구
- Docker & Docker Compose
- Python 3.11+
- SQLite 3
- curl, jq
- Rich library (CLI 진행바)

---

## 📅 예상 타임라인

| Phase | 작업 | 예상 시간 |
|-------|------|----------|
| **Phase 0** | 선행 조건 정리 (CLI/문서/CI) | 30-45분 |
| **Phase 1** | 환경 설정 | 30분 |
| **Phase 2** | V1-V7 검증 | 2시간 |
| **Phase 3** | 체크리스트 & 문서 | 1-1.5시간 |
| **Phase 4** | 정리 & 커밋 | 15분 |
| **합계** | **전체** | **3.5-4.5시간** |

---

## 🎯 최종 결과물

이슈 완료 후 다음 파일들이 생성/업데이트됩니다:

1. ✅ 검증 로그: `logs/approval_workflow/` (V1-V7 각 시나리오별)
2. ✅ 검증 요약: `logs/approval_workflow/VERIFICATION_SUMMARY.md`
3. ✅ 기본 문서: `docs/progress/v1/fb_19.md` (검증 결과 추가)
4. ✅ 보안 문서: `docs/security/IMPLEMENTATION_SUMMARY.md` (환경 변수/승인 절차 반영)
5. ✅ 프로젝트 문서: `CLAUDE.md` (검증 완료 상태)
6. ✅ Git commit: 모든 변경사항 커밋

---

**상태**: ✅ 분석 완료, Ready to Execute
**다음 단계**: Phase 1 환경 설정 시작
