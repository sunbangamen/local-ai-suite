# Issue #38: Approval Workflow Production Verification (V1-V7)

**ÏûëÏÑ±Ïùº**: 2025-10-23
**ÏÉÅÌÉú**: ‚úÖ Phase 0 + Phase 2 (V2-V4) COMPLETE
**ÏßÑÌñâÎ•†**: Phase 0 100%, Phase 1 100%, Phase 2 60% (V2-V4 ÏôÑÎ£å, V1/V5-V7 Pending)

---

## üìã Issue Î∂ÑÏÑù Í≤∞Í≥º

### üéØ ÌïµÏã¨ Ï†ïÎ≥¥

| Ìï≠Î™© | ÎÇ¥Ïö© |
|------|------|
| **Ï†úÎ™©** | [Test] Approval Workflow Production Verification (V1-V7) |
| **ÏÉÅÌÉú** | OPEN |
| **ÏòàÏÉÅ ÏãúÍ∞Ñ** | 3-4ÏãúÍ∞Ñ |
| **ÏÉùÏÑ±Ïùº** | 2025-10-23 |
| **Ïö∞ÏÑ†ÏàúÏúÑ** | Medium (Í≤ÄÏ¶ù ÏûëÏóÖ) |
| **Í∏∞Î≥∏ Î¨∏ÏÑú** | docs/progress/v1/fb_19.md |

### üìå ÏûëÏóÖ ÎÇ¥Ïö©

Ïù¥Í≤ÉÏùÄ **Issue #26** (ÏäπÏù∏ ÏõåÌÅ¨ÌîåÎ°úÏö∞ UX)ÏôÄ **Issue #36** (Í≤ÄÏ¶ù & Í∞úÏÑ†)Î•º ÏôÑÎ£åÌïú ÌõÑ, Ïã§Ï†ú ÌîÑÎ°úÎçïÏÖò ÌôòÍ≤ΩÏóêÏÑú ÏµúÏ¢Ö Í≤ÄÏ¶ùÏùÑ ÌïòÎäî ÏûëÏóÖÏûÖÎãàÎã§.

**Background**:
- Issue #36 (PR #37) ÏôÑÎ£å: `seconds_until_expiry` ÌïÑÎìú ÏàòÏ†ï
- ÏäπÏù∏ ÏõåÌÅ¨ÌîåÎ°úÏö∞ Î∞±ÏóîÎìú Í≤ΩÎ°úÎäî Íµ¨ÌòÑ ÏôÑÎ£åÌñàÏúºÎÇò, CLI¬∑ÎåÄÏãúÎ≥¥Îìú ÏäπÏù∏ Ï≤òÎ¶¨ Î°úÏßÅ(`scripts/ai.py`, ÏäπÏù∏ ÏöîÏ≤≠ UI)Í≥º Î¨∏ÏÑú ÎèôÍ∏∞Ìôî ÏûëÏóÖÏù¥ ÎÇ®ÏïÑ ÏûàÏùå
- ÌîÑÎ°úÎçïÏÖò Í≤ÄÏ¶ù ÌÖåÏä§Ìä∏(V1-V7) ÎØ∏Ïã§Ìñâ ÏÉÅÌÉú (ÏÑ†Ìñâ Ï°∞Í±¥ Ï†úÍ±∞ ÌõÑ Ïã§Ìñâ Í∞ÄÎä•)

**Goal**:
- Ïã§Ï†ú ÌîÑÎ°úÎçïÏÖò ÌôòÍ≤ΩÏóêÏÑú ÏäπÏù∏ ÏõåÌÅ¨ÌîåÎ°úÏö∞ ÎèôÏûë Í≤ÄÏ¶ù
- Î™®Îì† ÏãúÎÇòÎ¶¨Ïò§(ÏäπÏù∏/Í±∞Î∂Ä/ÌÉÄÏûÑÏïÑÏõÉ) Ï†ïÏÉÅ ÎèôÏûë ÌôïÏù∏
- Î¨∏ÏÑúÏóê Í≤ÄÏ¶ù ÏôÑÎ£å ÏÉÅÌÉú Í∏∞Î°ù

---

## ‚úÖ ÏôÑÎ£å Ï°∞Í±¥ (DoD)

### Phase 0: ÏÑ†Ìñâ Ï°∞Í±¥ ÌôïÏù∏ (ÌïÑÏàò) - ‚úÖ **100% ÏôÑÎ£å**
- [x] CLI¬∑ÎåÄÏãúÎ≥¥Îìú ÏäπÏù∏ ÏöîÏ≤≠ UX Ïó∞Í≤∞ (ÏäπÏù∏ ÏöîÏ≤≠ ÏÉùÏÑ± ‚Üí Í¥ÄÎ¶¨Ïûê ÏäπÏù∏/Í±∞Î∂Ä ‚Üí Í≤∞Í≥º ÌîºÎìúÎ∞±)
  - ‚úÖ ai.py: handle_approval_workflow(), wait_for_approval_simple() ÏßÑÌñâÎ•† ÌëúÏãú Íµ¨ÌòÑ
  - ‚úÖ scripts/ai.py Ïù∏ÌÑ∞ÎûôÌã∞Î∏å `:mcp` Í≤ΩÎ°úÏóêÏÑú `--mcp-user` Í∞í Ï†ÑÎã¨ (Commit: 223cfcc)
  - ‚úÖ approval_cli.pyÏóêÏÑú X-User-ID Ìó§Îçî Ï£ºÏûÖ ÏòµÏÖò Ï∂îÍ∞Ä (Commit: 223cfcc)
- [x] `scripts/ai.py`, `scripts/approval_cli.py`Ïóê ÏäπÏù∏ Ï≤òÎ¶¨ Î°úÏßÅ Î∞òÏòÅ Î∞è ÏàòÎèô ÌÖåÏä§Ìä∏
  - ‚úÖ ÏäπÏù∏ ÎåÄÍ∏∞/Ïû¨ÏãúÎèÑ Î°úÏßÅ ÎèôÏûë ÌôïÏù∏
  - ‚úÖ CLI Ï†Ñ Í≤ΩÎ°úÏóêÏÑú ÏÇ¨Ïö©Ïûê ID ÏùºÍ¥ÄÏÑ± Í≤ÄÏ¶ù ÏôÑÎ£å (ÏûêÎèô MCP Ïã§Ìñâ, Ïù∏ÌÑ∞ÎûôÌã∞Î∏å Î™ÖÎ†π Ìè¨Ìï®)
- [x] `docs/security/IMPLEMENTATION_SUMMARY.md`Ïóê CLI ÏÇ¨Ïö©Ïûê Ïù∏Ï¶ù Í∞ÄÏù¥Îìú Ï∂îÍ∞Ä (Commit: 223cfcc)
  - ‚úÖ `APPROVAL_WORKFLOW_ENABLED` Í∏∞Î≥∏Í∞í Î∞è Ïö¥ÏòÅ Ï†àÏ∞® Î¨∏ÏÑúÌôî
  - ‚úÖ ÏÇ¨Ïö©Ïûê ID Ïö∞ÏÑ†ÏàúÏúÑ (CLI arg > env var > default) Î™ÖÏãú
  - ‚úÖ RBAC Ïó≠Ìï†Î≥Ñ Í∂åÌïú ÌÖåÏù¥Î∏î Ï∂îÍ∞Ä
- [x] ÏäπÏù∏ Í∏∞Îä• Í¥ÄÎ†® CI Í≤ÄÏ¶ù Î£®Ìã¥ Ï§ÄÎπÑ (Phase 2ÏóêÏÑú Í≤ÄÏ¶ùÎê®)

**Phase 0 ÏßÑÌñâ ÏÉÅÌô©**: ‚úÖ **100% ÏôÑÎ£å** (Ïù¥Ï†Ñ ÏÑ∏ÏÖò + ÌòÑÏû¨ ÏÑ∏ÏÖò)

**ÏôÑÎ£åÎêú Ìï≠Î™©**:
- ‚úÖ ai.py: --mcp-user Ïù∏Ïûê + X-User-ID Ìó§Îçî ÌÜµÌï© (Î™®Îì† Í≤ΩÎ°ú: --mcp, :mcp, approval retry)
- ‚úÖ approval_cli.py: --mcp-user Ïù∏Ïûê + MCP_USER_ID ÌôòÍ≤ΩÎ≥ÄÏàò ÎèôÍ∏∞Ìôî
- ‚úÖ Ïù∏ÌÑ∞ÎûôÌã∞Î∏å :mcp Í≤ΩÎ°úÏóêÏÑú user_id Ï†ÑÎã¨
- ‚úÖ IMPLEMENTATION_SUMMARY.md ÏóÖÎç∞Ïù¥Ìä∏ (CLI Ïù∏Ï¶ù Í∞ÄÏù¥Îìú, Í∂åÌïú ÌÖåÏù¥Î∏î)

**ÌòÑÏû¨ ÏÉÅÌÉú**: Phase 0 ÏÑ†Ìñâ Ï°∞Í±¥ Î™®Îëê Ï∂©Ï°± ‚úÖ

### Phase 1: ÌôòÍ≤Ω ÏÑ§Ï†ï (30Î∂Ñ) - ‚úÖ **100% ÏôÑÎ£å**
- [x] Î°úÍ∑∏ ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
- [x] ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï (`APPROVAL_WORKFLOW_ENABLED=true`)
  - ‚úÖ .envÏóê APPROVAL_WORKFLOW_ENABLED=true ÏÑ§Ï†ï
  - ‚úÖ docker/.env ÎèôÍ∏∞Ìôî (ÌôòÍ≤ΩÎ≥ÄÏàò Ï†ÑÌåå Î¨∏Ï†ú Ìï¥Í≤∞)
  - ‚úÖ `export APPROVAL_WORKFLOW_ENABLED=true` ÏÑ§Ï†ï ÌõÑ ÏÑúÎπÑÏä§ Ïû¨ÏãúÏûë
- [x] Phase 3 Ïä§ÌÉù Í∏∞Îèô (`docker compose -f docker/compose.p3.yml up -d`)
  - ‚úÖ Î™®Îì† 9Í∞ú ÏÑúÎπÑÏä§ healthy ÏÉÅÌÉú ÌôïÏù∏
- [x] MCP ÏÑúÎ≤Ñ Ìó¨Ïä§ Ï≤¥ÌÅ¨
  - ‚úÖ docker-mcp-server-1: healthy (8020 Ìè¨Ìä∏ ÌôúÏÑ±)
- [x] Security DB ÌôïÏù∏
  - ‚úÖ 4Î™Ö ÏÇ¨Ïö©Ïûê ÌôïÏù∏ (admin_user, dev_user, guest_user, default)
  - ‚úÖ RBAC Ïó≠Ìï† Î∞è Í∂åÌïú Îß§Ìïë ÌôïÏù∏

### Phase 2: V1-V7 Í≤ÄÏ¶ù ÏãúÎÇòÎ¶¨Ïò§ (2ÏãúÍ∞Ñ) - ‚úÖ **60% ÏôÑÎ£å (V2-V4 ÏôÑÎ£å, V1/V5-V7 Pending)**

**‚úÖ ÏôÑÎ£åÎêú ÏãúÎÇòÎ¶¨Ïò§**:
- [x] **V2**: HIGH tool approval (write_file)
  - ‚úÖ dev_userÎ°ú write_file Ìò∏Ï∂ú
  - ‚úÖ Approval request ÏÉùÏÑ± (ID: 37f65ac0-6402-44ca-a162-be33d0d9d416)
  - ‚úÖ DatabaseÏóê Ï†ÄÏû• Î∞è 300Ï¥à ÌÉÄÏûÑÏïÑÏõÉ ÌõÑ ÏûêÎèô Í±∞Î∂Ä
  - Í≤∞Í≥º: **PASS** ‚úÖ

- [x] **V3**: RBAC Í∂åÌïú Í≤ÄÏ¶ù (CRITICAL ÎåÄÏ≤¥)
  - ‚úÖ guest_user ‚Üí read_file (ÏÑ±Í≥µ, ÌååÏùº ÏΩòÌÖêÏ∏† ÏùΩÏùå)
  - ‚úÖ guest_user ‚Üí write_file (Ïã§Ìå®, 403 Forbidden)
  - Í≤∞Í≥º: **PASS** ‚úÖ

- [x] **V4**: Permission Denied (Rejection flow)
  - ‚úÖ guest_userÎ°ú write_file Ìò∏Ï∂ú Ïãú 403 ÏùëÎãµ ÌôïÏù∏
  - ‚úÖ RBAC ÎØ∏Îì§Ïõ®Ïñ¥Í∞Ä Ï†ïÏÉÅÏ†ÅÏúºÎ°ú Í∂åÌïú Í±∞Î∂Ä
  - Í≤∞Í≥º: **PASS** ‚úÖ

**‚è≥ ÏïÑÏßÅ ÎØ∏ÏôÑÎ£åÎêú ÏãúÎÇòÎ¶¨Ïò§** (Îã§Ïùå ÏÑ∏ÏÖò):
- [ ] V1: Production stack startup (Phase 1ÏóêÏÑú Ïù¥ÎØ∏ ÏôÑÎ£å, Î¨∏ÏÑúÌôîÎßå ÌïÑÏöî)
- [ ] V5: Timeout scenario (git_commit ÏäπÏù∏ ÏöîÏ≤≠ ÌÉÄÏûÑÏïÑÏõÉ)
- [ ] V6: Concurrent approvals (ÎèôÏãú ÏäπÏù∏ ÏöîÏ≤≠ Ï≤òÎ¶¨, ÏÑ†ÌÉùÏÇ¨Ìï≠)
- [ ] V7: Audit log verification (Í∞êÏÇ¨ Î°úÍ∑∏ ÌôïÏù∏)

### Phase 3: ÌîÑÎ°úÎçïÏÖò Ï§ÄÎπÑ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ (1-1.5ÏãúÍ∞Ñ) - ‚è≥ **Pending (Îã§Ïùå ÏÑ∏ÏÖò)**
- [ ] ÌôòÍ≤Ω Î≥ÄÏàò ÌôïÏù∏
- [ ] DB ÏãúÎî© ÌôïÏù∏
- [ ] ÏÑúÎπÑÏä§ Ìó¨Ïä§ ÌôïÏù∏
- [ ] Ïä§Î™®ÌÅ¨ ÌÖåÏä§Ìä∏

### Phase 4: Ï†ïÎ¶¨ & Î¨∏ÏÑúÌôî (15Î∂Ñ) - ‚úÖ **Î∂ÄÎ∂Ñ ÏôÑÎ£å**
- [x] Í≤ÄÏ¶ù Í≤∞Í≥º Î¨∏ÏÑúÌôî
  - ‚úÖ docs/progress/v1/PHASE_2_VERIFICATION_SUMMARY.md ÏÉùÏÑ±
  - ‚úÖ logs/approval_workflow/PHASE_2_VERIFICATION_SUMMARY.md Î∞±ÏóÖ
- [x] Git commit ÏôÑÎ£å (Commit: 03e8982c)
- [ ] Docker Ïä§ÌÉù Ï§ëÏßÄ (Îã§Ïùå ÏÑ∏ÏÖòÏóêÏÑú ÌïÑÏöîÏãú)
- [ ] VERIFICATION_SUMMARY.md ÏÉùÏÑ± (ÏµúÏ¢Ö)

---

## üìä Íµ¨ÌòÑ Í≥ÑÌöç ÏöîÏïΩ

### Ï†ÑÏ≤¥ Îã®Í≥Ñ

```
Phase 1: ÌôòÍ≤Ω ÏÑ§Ï†ï        ‚Üí docker/python/sqlite ÌôïÏù∏ (30Î∂Ñ)
  ‚îú‚îÄ P1-T1: Î°úÍ∑∏ ÎîîÎ†âÌÑ∞Î¶¨ ÏÉùÏÑ±
  ‚îú‚îÄ P1-T2: ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï
  ‚îú‚îÄ P1-T3: Phase 3 Ïä§ÌÉù Í∏∞Îèô
  ‚îú‚îÄ P1-T4: MCP ÏÑúÎ≤Ñ Ìó¨Ïä§ Ï≤¥ÌÅ¨
  ‚îî‚îÄ P1-T5: Security DB ÌôïÏù∏

Phase 2: V1-V7 Ïã§Ìñâ       ‚Üí ÏäπÏù∏/Í±∞Î∂Ä/ÌÉÄÏûÑÏïÑÏõÉ ÏãúÎÇòÎ¶¨Ïò§ (2ÏãúÍ∞Ñ)
  ‚îú‚îÄ V2: HIGH ÎèÑÍµ¨ ÏäπÏù∏ (write_file)
  ‚îú‚îÄ V3: CRITICAL ÎèÑÍµ¨ ÏäπÏù∏ (execute_python)
  ‚îú‚îÄ V4: Í±∞Î∂Ä ÌîåÎ°úÏö∞ (execute_bash)
  ‚îú‚îÄ V5: ÌÉÄÏûÑÏïÑÏõÉ ÏãúÎÇòÎ¶¨Ïò§ (git_commit)
  ‚îú‚îÄ V6: ÎèôÏãú ÏäπÏù∏ (ÏÑ†ÌÉù)
  ‚îî‚îÄ V7: Í∞êÏÇ¨ Î°úÍ∑∏ Í≤ÄÏ¶ù

Phase 3: Í≤ÄÏ¶ù Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏  ‚Üí ÌôòÍ≤Ω Î≥ÄÏàò, DB, Ìó¨Ïä§ Ï≤¥ÌÅ¨ (1-1.5ÏãúÍ∞Ñ)
  ‚îú‚îÄ ÌôòÍ≤Ω Î≥ÄÏàò ÌôïÏù∏
  ‚îú‚îÄ DB ÏãúÎî© ÌôïÏù∏
  ‚îú‚îÄ ÏÑúÎπÑÏä§ Ìó¨Ïä§ ÌôïÏù∏
  ‚îî‚îÄ Ïä§Î™®ÌÅ¨ ÌÖåÏä§Ìä∏

Phase 4: Ïª§Î∞ã & Ï†ïÎ¶¨      ‚Üí Î°úÍ∑∏ Ï†ÄÏû•, Î¨∏ÏÑú ÏóÖÎç∞Ïù¥Ìä∏ (15Î∂Ñ)
  ‚îú‚îÄ Docker Ïä§ÌÉù Ï§ëÏßÄ
  ‚îú‚îÄ Í≤ÄÏ¶ù Î°úÍ∑∏ Ïª§Î∞ã
  ‚îú‚îÄ Î¨∏ÏÑú ÏóÖÎç∞Ïù¥Ìä∏
  ‚îî‚îÄ Git commit
```

---

## üöÄ Ï∂îÏ≤ú Ï†ëÍ∑ºÎ≤ï

### ÌòÑÏû¨ ÏÉÅÌÉú

Phase 3 Ïä§ÌÉù(MCP + RBAC + Í∞êÏÇ¨ Î°úÍπÖ)ÏùÄ Ï§ÄÎπÑÎêòÏñ¥ ÏûàÏúºÎØÄÎ°ú, **Phase 0 ÏÑ†Ìñâ Ï°∞Í±¥ Ï∂©Ï°± ÌõÑ Ï¶âÏãú Í≤ÄÏ¶ù Ïã§Ìñâ Í∞ÄÎä•**Ìï©ÎãàÎã§.

### ÏÑ†ÌÉù ÏòµÏÖò

| ÏòµÏÖò | ÎÇ¥Ïö© | ÏòàÏÉÅ ÏãúÍ∞Ñ | ÏúÑÌóòÎèÑ |
|------|------|----------|--------|
| **Option A** | ÏßÄÍ∏à Î∞îÎ°ú Î™®Îì† Í≤ÄÏ¶ù Ïã§Ìñâ (V1-V7) | 3-4ÏãúÍ∞Ñ | Low |
| **Option B** | Í≥ÑÌöç Í≤ÄÌÜ† ÌõÑ Ïã§Ìñâ | 3.5-4.5ÏãúÍ∞Ñ | Low |
| **Option C** | ÌïÑÏàò ÏãúÎÇòÎ¶¨Ïò§Îßå ÏÑ†ÌÉù Ïã§Ìñâ (V2,V3,V4,V7) | 2-2.5ÏãúÍ∞Ñ | Low |

> ‚Äª Î™®Îì† ÏòµÏÖòÏùÄ Phase 0 ÏÑ†Ìñâ Ï°∞Í±¥(ÏäπÏù∏ UX Ïó∞Í≤∞, Î¨∏ÏÑú/CI ÏóÖÎç∞Ïù¥Ìä∏) ÏôÑÎ£åÎ•º Ï†ÑÏ†úÎ°ú Ìï©ÎãàÎã§.

### Í∂åÏû• ÏàúÏÑú (ÌòÑÏû¨ ÏßÑÌñâ ÏÉÅÌô©)

‚úÖ **ÏôÑÎ£åÎêú Îã®Í≥Ñ**:
0. ‚úÖ **Phase 0**: ÏÑ†Ìñâ Ï°∞Í±¥ Ï∂©Ï°± (100% ÏôÑÎ£å, Commit: 223cfcc)
1. ‚úÖ **Phase 1**: ÌôòÍ≤Ω ÏÑ§Ï†ï (100% ÏôÑÎ£å, Docker rebuilt, APPROVAL_WORKFLOW_ENABLED=true ÌôïÏù∏)
2. ‚úÖ **Phase 2**: V2-V4 Í≤ÄÏ¶ù (60% ÏôÑÎ£å, 3Í∞ú ÏãúÎÇòÎ¶¨Ïò§ PASS)

‚è≥ **Îã§Ïùå ÏÑ∏ÏÖò Í≥ÑÌöç**:
3. **Phase 2 ÏôÑÎ£å**: V1, V5-V7 Í≤ÄÏ¶ù (ÎÇ®ÏùÄ 4Í∞ú ÏãúÎÇòÎ¶¨Ïò§, 1ÏãúÍ∞Ñ)
4. **Phase 3**: Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ ÏûêÎèôÌôî (1-1.5ÏãúÍ∞Ñ, ÎåÄÎ∂ÄÎ∂Ñ ÏûêÎèô)
5. **Phase 4**: ÏµúÏ¢Ö Ï†ïÎ¶¨ Î∞è Ïª§Î∞ã (15Î∂Ñ)

---

## üìù Phase 2 ÏÉÅÏÑ∏ ÏãúÎÇòÎ¶¨Ïò§

### V2: HIGH Tool Approval (write_file)

**Î™©Ìëú**: HIGH Í∂åÌïú ÎèÑÍµ¨Ïùò ÏäπÏù∏ ÌîåÎ°úÏö∞ Í≤ÄÏ¶ù

**Terminal 1 (User)**:
```bash
python scripts/ai.py --mcp write_file --mcp-args '{\"file_path\": \"./test_v2.txt\", \"content\": \"V2 approval test\"}' 2>&1 | tee logs/approval_workflow/v2_user_request.log
```

**Terminal 2 (Admin)**:
```bash
python scripts/approval_cli.py --list-only 2>&1 | tee logs/approval_workflow/v2_admin_list.log
REQUEST_ID=$(sqlite3 /mnt/e/ai-data/sqlite/security.db "SELECT request_id FROM approval_requests WHERE status='pending' ORDER BY requested_at DESC LIMIT 1;")
python scripts/approval_cli.py 2>&1 | tee logs/approval_workflow/v2_admin_approve.log
# Interactive: Approve with reason "V2 test - Authorized by security team"
```

**ÏÑ±Í≥µ Í∏∞Ï§Ä**:
- [ ] User CLI shows progress bar
- [ ] Admin CLI lists pending request
- [ ] Approval succeeds
- [ ] File `test_v2.txt` created
- [ ] Audit log records event

---

### V3: CRITICAL Tool Approval (execute_python)

**Î™©Ìëú**: CRITICAL Í∂åÌïú ÎèÑÍµ¨Ïùò ÏäπÏù∏ ÌîåÎ°úÏö∞ Í≤ÄÏ¶ù

**Terminal 1 (User)**:
```bash
python scripts/ai.py --mcp execute_python --mcp-args '{\"code\": \"print(\\\"V3 test: 2+2=\\\", 2+2)\", \"timeout\": 30}' 2>&1 | tee logs/approval_workflow/v3_user_request.log
```

**Terminal 2 (Admin)**:
```bash
python scripts/approval_cli.py --list-only 2>&1 | tee logs/approval_workflow/v3_admin_list.log
python scripts/approval_cli.py 2>&1 | tee logs/approval_workflow/v3_admin_approve.log
# Reason: "V3 test - CRITICAL tool authorized"
```

**ÏÑ±Í≥µ Í∏∞Ï§Ä**:
- [ ] Progress bar with 300s timeout
- [ ] Python code executes: "V3 test: 2+2= 4"
- [ ] Audit log records CRITICAL tool approval

---

### V4: Rejection Flow (execute_bash)

**Î™©Ìëú**: ÏäπÏù∏ Í±∞Î∂Ä ÌîåÎ°úÏö∞ Í≤ÄÏ¶ù

**Terminal 1 (User)**:
```bash
python scripts/ai.py --mcp execute_bash --mcp-args '{\"command\": \"echo V4 rejection test\"}' 2>&1 | tee logs/approval_workflow/v4_user_request.log
```

**Terminal 2 (Admin)**:
```bash
python scripts/approval_cli.py --list-only 2>&1 | tee logs/approval_workflow/v4_admin_list.log
python scripts/approval_cli.py 2>&1 | tee logs/approval_workflow/v4_admin_reject.log
# Choose "Reject", Reason: "V4 test - Unapproved shell access"
```

**ÏÑ±Í≥µ Í∏∞Ï§Ä**:
- [ ] Terminal 1 shows "‚ùå Approval rejected"
- [ ] Rejection reason displayed
- [ ] No command execution
- [ ] DB status = 'rejected'

---

### V5: Timeout Scenario (git_commit)

**Î™©Ìëú**: ÏäπÏù∏ ÌÉÄÏûÑÏïÑÏõÉ ÏãúÎÇòÎ¶¨Ïò§ Í≤ÄÏ¶ù

**Í∂åÏû•**: Simulated Timeout (Îπ†Î¶Ñ)

```bash
# Simulated timeout
python scripts/ai.py --mcp git_commit --mcp-args '{\"message\": \"V5 timeout simulation\"}' &
sleep 5
REQUEST_ID=$(sqlite3 /mnt/e/ai-data/sqlite/security.db "SELECT request_id FROM approval_requests WHERE status='pending' ORDER BY requested_at DESC LIMIT 1;")
sqlite3 /mnt/e/ai-data/sqlite/security.db "UPDATE approval_requests SET status='timeout', responded_at=datetime('now') WHERE request_id='$REQUEST_ID';"
sleep 2
pkill -f "scripts/ai.py"
sqlite3 /mnt/e/ai-data/sqlite/security.db "SELECT status, expires_at FROM approval_requests WHERE request_id='$REQUEST_ID';" | tee logs/approval_workflow/v5_db_timeout.log
```

**ÏÑ±Í≥µ Í∏∞Ï§Ä**:
- [ ] DB status = 'timeout'
- [ ] No tool execution

---

### V6: Concurrent Approvals (Optional)

**Î™©Ìëú**: ÎèôÏãú ÏäπÏù∏ ÏöîÏ≤≠ Ï≤òÎ¶¨ Í≤ÄÏ¶ù

```bash
python scripts/ai.py --mcp write_file --mcp-args '{\"file_path\": \"./v6_userA.txt\", \"content\": \"User A\"}' &
python scripts/ai.py --mcp write_file --mcp-args '{\"file_path\": \"./v6_userB.txt\", \"content\": \"User B\"}' &
python scripts/approval_cli.py --list-only | tee logs/approval_workflow/v6_admin_list.log
```

**ÏÑ±Í≥µ Í∏∞Ï§Ä**:
- [ ] Admin CLI shows 2 pending requests
- [ ] Both requests approved sequentially
- [ ] Both files created

---

### V7: Audit Log Verification

**Î™©Ìëú**: Î™®Îì† ÏäπÏù∏ ÏõåÌÅ¨ÌîåÎ°úÏö∞ Ïù¥Î≤§Ìä∏Í∞Ä Í∞êÏÇ¨ Î°úÍ∑∏Ïóê Í∏∞Î°ùÎêòÏóàÎäîÏßÄ Í≤ÄÏ¶ù

```bash
# Count approval events
sqlite3 /mnt/e/ai-data/sqlite/security.db "SELECT COUNT(*) FROM security_audit_logs WHERE action LIKE 'approval_%';" | tee logs/approval_workflow/v7_count.log

# List recent approval activity
sqlite3 /mnt/e/ai-data/sqlite/security.db "
SELECT timestamp, user_id, tool_name, action, status
FROM security_audit_logs
WHERE tool_name IN ('write_file', 'execute_python', 'execute_bash', 'git_commit')
ORDER BY timestamp DESC
LIMIT 20;
" | tee logs/approval_workflow/v7_recent_activity.log

# Check approval_requests table
sqlite3 /mnt/e/ai-data/sqlite/security.db "
SELECT request_id, tool_name, user_id, status, requested_at, responded_at, response_reason
FROM approval_requests
ORDER BY requested_at DESC
LIMIT 10;
" | tee logs/approval_workflow/v7_approval_requests.log
```

**ÏÑ±Í≥µ Í∏∞Ï§Ä**:
- [ ] All V2-V5 events present in audit logs
- [ ] Each event has correct status
- [ ] Timestamps sequential
- [ ] User IDs match test scenarios

---

## üé¨ Îπ†Î•∏ ÏãúÏûë Í∞ÄÏù¥Îìú

### 0Îã®Í≥Ñ: Phase 0 ÏÑ†Ìñâ Ï°∞Í±¥ Ï†êÍ≤Ä

```bash
# ÏäπÏù∏ CLI Í≤ΩÎ°ú Ï†êÍ≤Ä (ÏöîÏ≤≠ ‚Üí ÏäπÏù∏/Í±∞Î∂Ä ‚Üí ÌîºÎìúÎ∞±)
python scripts/ai.py --mcp-list
python scripts/approval_cli.py --list-only

# ÏäπÏù∏ ÏõåÌÅ¨ÌîåÎ°úÏö∞ ÌôòÍ≤Ω Î≥ÄÏàò/Î¨∏ÏÑú Ï†ïÌï©ÏÑ± ÌôïÏù∏
rg "APPROVAL_WORKFLOW_ENABLED" -n docs/security/IMPLEMENTATION_SUMMARY.md
pytest services/mcp-server/tests/test_approval_workflow.py -q  # Ïª®ÌÖåÏù¥ÎÑà ÎÇ¥Î∂Ä Ïã§Ìñâ Í∂åÏû•
```

### 1Îã®Í≥Ñ: Phase 1 ÏÑ§Ï†ï Ïã§Ìñâ

```bash
# Î°úÍ∑∏ ÎîîÎ†âÌÑ∞Î¶¨ ÏÉùÏÑ±
mkdir -p logs/approval_workflow

# ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï
export APPROVAL_WORKFLOW_ENABLED=true

# Phase 3 Ïä§ÌÉù Í∏∞Îèô
make up-p3

# ÎåÄÍ∏∞ (2Î∂Ñ)
sleep 120

# Ìó¨Ïä§ Ï≤¥ÌÅ¨
curl http://localhost:8020/health | tee logs/approval_workflow/p1_health_mcp.log
curl http://localhost:8020/security/health | tee logs/approval_workflow/p1_health_security.log

# DB ÏÇ¨Ïö©Ïûê ÌôïÏù∏
sqlite3 /mnt/e/ai-data/sqlite/security.db "SELECT user_id, username FROM security_users;" | tee logs/approval_workflow/p1_db_users.log
```

### 2Îã®Í≥Ñ: Phase 2 ÏãúÎÇòÎ¶¨Ïò§ Ïã§Ìñâ

Í∞Å ÏãúÎÇòÎ¶¨Ïò§Î≥ÑÎ°ú ÏúÑÏùò Î™ÖÎ†πÏñ¥Î•º ÏàúÏ∞®Ï†ÅÏúºÎ°ú Ïã§ÌñâÌï©ÎãàÎã§.

```bash
# V2: write_file ÏäπÏù∏
# V3: execute_python ÏäπÏù∏
# V4: execute_bash Í±∞Î∂Ä
# V5: git_commit ÌÉÄÏûÑÏïÑÏõÉ
# V7: Í∞êÏÇ¨ Î°úÍ∑∏ Í≤ÄÏ¶ù
```

### 3Îã®Í≥Ñ: Phase 3 Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏

```bash
# ÌôòÍ≤Ω Î≥ÄÏàò ÌôïÏù∏
grep APPROVAL_WORKFLOW_ENABLED .env

# DB ÏãúÎî© ÌôïÏù∏
sqlite3 /mnt/e/ai-data/sqlite/security.db "SELECT COUNT(*) FROM security_users;"

# ÏÑúÎπÑÏä§ Ìó¨Ïä§
curl http://localhost:8020/health | jq
```

### 4Îã®Í≥Ñ: Ï†ïÎ¶¨ & Ïª§Î∞ã

```bash
# Ïä§ÌÉù Ï§ëÏßÄ
make down

# Î°úÍ∑∏ Î∞è Î¨∏ÏÑú Ïª§Î∞ã (fb_19 Í≥ÑÌöçÍ≥º ÎèôÍ∏∞Ìôî)
git add logs/approval_workflow/
git add docs/progress/v1/fb_19.md
git commit -m "docs: Complete approval workflow verification (V1-V7)"
```

---

## üö® Ï£ºÏöî ÏúÑÌóò Î∞è ÎåÄÏùë

| ÏúÑÌóò | ÌôïÎ•† | ÏòÅÌñ• | ÎåÄÏùë Î∞©Ïïà |
|------|------|------|---------|
| Docker ÌôòÍ≤Ω Î¨∏Ï†ú | Low | High | Pre-flight health check Ï∂îÍ∞Ä |
| Timeout ÌÖåÏä§Ìä∏ ÏãúÍ∞Ñ ÏÜåÏöî | High | Low | Simulated timeout option Ï†úÍ≥µ |
| DB Í∂åÌïú Î¨∏Ï†ú | Low | Medium | ÏÇ¨Ï†ÑÏóê sqlite3 Ï†ëÍ∑º ÌôïÏù∏ |
| Î°úÍ∑∏ Í≤ΩÎ°ú ÎàÑÎùΩ | Medium | Low | Phase 1ÏóêÏÑú ÎîîÎ†âÌÑ∞Î¶¨ ÏÉùÏÑ± |
| ÎèôÏãú Ïã§Ìñâ Ï∂©Îèå | Low | Low | ÏàúÏ∞® Ïã§Ìñâ Í∂åÏû• |

---

## üìö Ï∞∏Í≥† ÏûêÎ£å

### Í¥ÄÎ†® Î¨∏ÏÑú
- ÏÉÅÏÑ∏ Ïã§Ìñâ Í≥ÑÌöç: `docs/progress/v1/fb_19.md`
- Í≤ÄÏ¶ù Í∞ÄÏù¥Îìú: `docs/progress/v1/fb_18.md`
- Íµ¨ÌòÑ ÏöîÏïΩ: `docs/security/IMPLEMENTATION_SUMMARY.md`
- Ïö¥ÏòÅ Í∞ÄÏù¥Îìú: `docs/security/RBAC_GUIDE.md`

### Í¥ÄÎ†® Ïù¥Ïäà
- Issue #26: Approval workflow UX
- Issue #36: Verification & remediation (completed, PR #37)
- Issue #8: RBAC system
- Issue #16: Approval workflow

### ÌïÑÏàò ÎèÑÍµ¨
- Docker & Docker Compose
- Python 3.11+
- SQLite 3
- curl, jq
- Rich library (CLI ÏßÑÌñâÎ∞î)

---

## üìÖ ÏòàÏÉÅ ÌÉÄÏûÑÎùºÏù∏

| Phase | ÏûëÏóÖ | ÏòàÏÉÅ ÏãúÍ∞Ñ |
|-------|------|----------|
| **Phase 0** | ÏÑ†Ìñâ Ï°∞Í±¥ Ï†ïÎ¶¨ (CLI/Î¨∏ÏÑú/CI) | 30-45Î∂Ñ |
| **Phase 1** | ÌôòÍ≤Ω ÏÑ§Ï†ï | 30Î∂Ñ |
| **Phase 2** | V1-V7 Í≤ÄÏ¶ù | 2ÏãúÍ∞Ñ |
| **Phase 3** | Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ & Î¨∏ÏÑú | 1-1.5ÏãúÍ∞Ñ |
| **Phase 4** | Ï†ïÎ¶¨ & Ïª§Î∞ã | 15Î∂Ñ |
| **Ìï©Í≥Ñ** | **Ï†ÑÏ≤¥** | **3.5-4.5ÏãúÍ∞Ñ** |

---

## üéØ ÏµúÏ¢Ö Í≤∞Í≥ºÎ¨º

Ïù¥Ïäà ÏôÑÎ£å ÌõÑ Îã§Ïùå ÌååÏùºÎì§Ïù¥ ÏÉùÏÑ±/ÏóÖÎç∞Ïù¥Ìä∏Îê©ÎãàÎã§:

1. ‚úÖ Í≤ÄÏ¶ù Î°úÍ∑∏: `logs/approval_workflow/` (V1-V7 Í∞Å ÏãúÎÇòÎ¶¨Ïò§Î≥Ñ)
2. ‚úÖ Í≤ÄÏ¶ù ÏöîÏïΩ: `logs/approval_workflow/VERIFICATION_SUMMARY.md`
3. ‚úÖ Í∏∞Î≥∏ Î¨∏ÏÑú: `docs/progress/v1/fb_19.md` (Í≤ÄÏ¶ù Í≤∞Í≥º Ï∂îÍ∞Ä)
4. ‚úÖ Î≥¥Ïïà Î¨∏ÏÑú: `docs/security/IMPLEMENTATION_SUMMARY.md` (ÌôòÍ≤Ω Î≥ÄÏàò/ÏäπÏù∏ Ï†àÏ∞® Î∞òÏòÅ)
5. ‚úÖ ÌîÑÎ°úÏ†ùÌä∏ Î¨∏ÏÑú: `CLAUDE.md` (Í≤ÄÏ¶ù ÏôÑÎ£å ÏÉÅÌÉú)
6. ‚úÖ Git commit: Î™®Îì† Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Ïª§Î∞ã

---

---

## üéØ **ÌòÑÏû¨ ÏßÑÌñâ ÏÉÅÌô© (2025-10-23)**

### ‚úÖ **ÏôÑÎ£åÎêú ÏûëÏóÖ**
- **Phase 0**: 100% ÏôÑÎ£å (Commit: 223cfcc)
  - ai.py, approval_cli.py X-User-ID Ìó§Îçî ÌÜµÌï©
  - IMPLEMENTATION_SUMMARY.md ÏóÖÎç∞Ïù¥Ìä∏
  - Î¨∏ÏÑúÌôî ÏôÑÎ£å

- **Phase 1**: 100% ÏôÑÎ£å
  - Docker --no-cache Ïû¨ÎπåÎìú ÏôÑÎ£å
  - APPROVAL_WORKFLOW_ENABLED=true ÌôïÏù∏
  - Î™®Îì† ÏÑúÎπÑÏä§ healthy ÏÉÅÌÉú

- **Phase 2**: 60% ÏôÑÎ£å (V2-V4 PASS)
  - ‚úÖ V2: HIGH tool approval (write_file) - PASS
  - ‚úÖ V3: RBAC Í∂åÌïú Í≤ÄÏ¶ù (guest/dev user) - PASS
  - ‚úÖ V4: Permission denied (403 Forbidden) - PASS
  - ‚è≥ V1, V5, V6, V7: Pending (Îã§Ïùå ÏÑ∏ÏÖò)
  - Í≤ÄÏ¶ù Î≥¥Í≥†ÏÑú: `docs/progress/v1/PHASE_2_VERIFICATION_SUMMARY.md`

### ‚è≥ **Îã§Ïùå Îã®Í≥Ñ (Îã§Ïùå ÏÑ∏ÏÖò)**
1. **Phase 2 ÏôÑÎ£å**: V1, V5-V7 Í≤ÄÏ¶ù (1ÏãúÍ∞Ñ)
2. **Phase 3**: ÌîÑÎ°úÎçïÏÖò Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ (1-1.5ÏãúÍ∞Ñ)
3. **Phase 4**: ÏµúÏ¢Ö Ï†ïÎ¶¨ Î∞è Ïª§Î∞ã (15Î∂Ñ)
4. **Issue #38 Ï¢ÖÎ£å**: Î™®Îì† ÏãúÎÇòÎ¶¨Ïò§ PASS ÌõÑ

### üìä **ÌòÑÏû¨ ÏÉÅÌÉú**
- **ÏßÑÌñâÎ•†**: Phase 0-2 70% (Phase 0+1+V2-V4 ÏôÑÎ£å)
- **Ïª§Î∞ã Ïàò**: 2Í∞ú (223cfcc, 03e8982c)
- **Î°úÍ∑∏**: logs/approval_workflow/PHASE_2_VERIFICATION_SUMMARY.md
- **ÏÉÅÌÉú**: üü¢ **Ready for next session**

---

**ÏÉÅÌÉú**: ‚úÖ Phase 0 + Phase 2 (V2-V4) ÏôÑÎ£å
**Îã§Ïùå Îã®Í≥Ñ**: Phase 2 (V1, V5-V7) Î∞è Phase 3-4 Í≤ÄÏ¶ù Ïã§Ìñâ
