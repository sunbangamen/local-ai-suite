# GitHub Issue #36 - 완전 분석 및 해결 계획

## Step 1: Issue Retrieval & Analysis

### Issue Information Summary
- **이슈 번호**: #36
- **제목**: [Enhancement] Approval Workflow UX - Production Verification & Remediation
- **상태**: OPEN
- **생성일**: 2025-10-23
- **담당자**: 미할당
- **라벨**: 없음
- **마일스톤**: Production Readiness

### Issue Content Analysis
**문제 유형**: Enhancement (개선 작업)
**우선순위**: High (프로덕션 검증 이슈)
**복잡도**: Medium (구현은 완료, 정합성 수정 필요)

**핵심 요구사항**:
1. ✅ **Issue #26의 승인 워크플로우는 100% 구현 완료**되었으나, 프로덕션 검증 과정에서 발견된 개선 사항 수정
2. 🔴 **CLI 문서 ↔ 실제 사용법 불일치** 해결
3. 🔴 **`seconds_until_expiry` 필드가 항상 0으로 표시되는 문제** 해결
4. 🟡 **통합 테스트 증거 부정확/누락** 문제 해결

**기술적 제약사항**:
- SQLite 기반 승인 요청 DB (WAL 모드)
- 기존 구현 코드 변경 최소화 (backwards compatibility 유지)
- 테스트 환경: Docker MCP 서버 (port 8020)
- 회귀 없이 현재 10개 통합 테스트 모두 통과해야 함

---

## Step 2: Technical Investigation

### Code Analysis - 현재 구현 상태

**1. CLI Tool (`scripts/approval_cli.py`)**
- **현재 구현**: Interactive mode 중심, argparse 기본 구조 있음
- **문제점**:
  - Line 317-323: `--list-only` 플래그는 있지만 `list`, `approve`, `reject` 하위 명령 미지원
  - 문서에는 `python scripts/approval_cli.py list` 사용 예시가 있지만 실제 동작 불가
- **해결 방안**: argparse subparsers 추가하여 `list`, `approve <id>`, `reject <id>` 명령 구현

**2. Security Admin API (`services/mcp-server/security_admin.py`)**
- **GET /api/approvals/pending** (Line 339-410):
  - Line 394: `"seconds_until_expiry": req.get("seconds_left", 0)` ← view가 제공하는 `seconds_until_expiry` 키를 읽지 못해 항상 0으로 대체
  - 문제: `pending_approvals` view는 이미 `seconds_until_expiry` 컬럼을 노출하므로 API 매핑을 수정해야 함

- **GET /api/approvals/{id}/status** (Line 544-593):
  - Line 578: 동일하게 `req.get("seconds_left", 0)` 사용 → `seconds_until_expiry` 키를 읽도록 교정 필요

**3. Database Layer (`services/mcp-server/security_database.py`)**
- **list_pending_approvals()** (Line 621-640):
  - `SELECT * FROM pending_approvals` ← View를 사용
  - View 정의를 확인하면 `seconds_until_expiry` 컬럼을 노출하고 있어 API가 올바른 키를 사용해야 함

**4. CLI Display Function (`scripts/approval_cli.py:178-224`)**
- **Line 207**: `seconds_left = req["seconds_left"]` ← 로컬 계산 필드를 사용
- **문제**: API는 `seconds_until_expiry`를 반환하고 view도 해당 키를 노출하지만 CLI는 별도 SQL로 `seconds_left`를 계산해 혼선을 야기
- **해결**: CLI와 API 모두 `seconds_until_expiry` 명칭으로 정규화하고 필요 시 CLI에서 필드명을 변환

### 영향 범위 분석
- **Backend API**: `security_admin.py` (2개 엔드포인트)
- **Database**: `pending_approvals` view 정의 확인 필요
- **CLI Tool**: `approval_cli.py` (argparse 구조 + display 함수)
- **Tests**: `test_approval_workflow.py` (10개 시나리오)
- **Documentation**: `RBAC_GUIDE.md`, `IMPLEMENTATION_SUMMARY.md`, `CLAUDE.md`

### Dependency Check
- **Depends on**: Issue #26 (Approval Workflow UX) - ✅ 100% 완료
- **Related to**:
  - Issue #8 (RBAC 시스템) - ✅ 100% 완료
  - Issue #16 (Approval Workflow) - ✅ 100% 완료
  - Issue #18 (Operations Readiness) - ✅ 100% 완료

---

## Step 3: Solution Strategy

### Option 1: CLI 하위 명령 추가 + API 필드 통일 (권장 ✅)
**장점**:
- 문서와 코드 완벽 일치
- 사용자 경험 개선 (명령형 인터페이스)
- API와 CLI 필드명 일관성 확보

**단점**:
- CLI 코드 변경 필요 (약 50-70줄)
- 기존 대화형 모드와 병행 관리 필요

**예상 시간**: 3-4 hours
**위험도**: Low (기존 기능 유지하며 추가)

### Option 2: 문서를 현재 구현 기준으로 수정
**장점**:
- 코드 변경 없음
- 빠른 작업 완료

**단점**:
- 사용자 경험 저하 (대화형 모드만 지원)
- 문서 예제의 간결함 손실
- `seconds_until_expiry` 문제는 여전히 해결 필요

**예상 시간**: 1-2 hours
**위험도**: Low

### Option 3: API와 DB View 모두 재설계
**장점**:
- 완벽한 아키텍처 정합성

**단점**:
- 과도한 작업량
- 회귀 위험 높음
- 기존 클라이언트 코드 영향

**예상 시간**: 8-10 hours
**위험도**: High

### 🎯 Recommended Approach: **Option 1**
**선택 이유**:
1. 프로덕션 검증 이슈의 핵심은 "문서-코드 정합성"
2. CLI 하위 명령은 실제 운영 시 필수 (자동화 스크립트에서 사용)
3. API 필드 통일은 간단한 변경 (backwards compatible)
4. 테스트 증거 갱신은 필수 작업

---

## Step 4: Detailed Implementation Plan

### Phase 1: 준비 및 환경 검증 (30분)

| Task | Description | DoD | Risk |
|------|-------------|-----|------|
| MCP 서버 실행 확인 | `curl http://localhost:8020/health` | 200 OK 응답 | Low |
| Security DB 확인 | `sqlite3 security.db "SELECT COUNT(*) FROM approval_requests;"` | 10개 테이블 존재 | Low |
| 환경 변수 검증 | `grep APPROVAL_WORKFLOW_ENABLED .env` | True 설정 확인 | Low |
| pending_approvals view 확인 | `sqlite3` 또는 schema.sql 파일 확인 | `seconds_until_expiry` 컬럼 확인 | Low |

### Phase 2: Priority 1 - CLI 하위 명령 구현 (2-3 hours)

| Task | Description | DoD | Risk |
|------|-------------|-----|------|
| argparse subparsers 추가 | `list`, `approve`, `reject` 하위 명령 생성 | `--help` 출력에 하위 명령 표시 | Low |
| `list` 명령 구현 | 대기 중인 승인 요청 표시 후 종료 | `python scripts/approval_cli.py list`에서 `seconds_until_expiry` 표시 | Low |
| `approve` 명령 구현 | `approve <request_id> --reason "..."` | 승인 처리 후 메시지 출력 | Medium |
| `reject` 명령 구현 | `reject <request_id> --reason "..."` | 거부 처리 후 메시지 출력 | Medium |
| 기존 대화형 모드 유지 | 인자 없이 실행 시 interactive mode | 호환성 유지 확인 | Low |
| CLI 테스트 | 문서 예제 재현 테스트 | RBAC_GUIDE.md 예제 모두 성공 | Low |

**구현 상세**:
```python
# approval_cli.py 수정 (Line 316 이후)
def main():
    parser = argparse.ArgumentParser(description="Approval Workflow CLI")
    subparsers = parser.add_subparsers(dest="command", help="Available commands")

    # list 명령
    list_parser = subparsers.add_parser("list", help="List pending approval requests")
    list_parser.add_argument("--limit", type=int, default=20, help="Maximum requests")

    # approve 명령
    approve_parser = subparsers.add_parser("approve", help="Approve a request")
    approve_parser.add_argument("request_id", help="Request ID (short or full UUID)")
    approve_parser.add_argument("--reason", required=True, help="Approval reason")

    # reject 명령
    reject_parser = subparsers.add_parser("reject", help="Reject a request")
    reject_parser.add_argument("request_id", help="Request ID (short or full UUID)")
    reject_parser.add_argument("--reason", required=True, help="Rejection reason")

    # ... 기존 --db, --responder 인자 추가
```

### Phase 3: Priority 2 - API 필드 통일 (1-2 hours)

| Task | Description | DoD | Risk |
|------|-------------|-----|------|
| pending_approvals view 조사 | schema.sql에서 `seconds_until_expiry` 계산 로직 확인 | API/CLI가 동일 키 사용 | Low |
| API 응답 테스트 | `curl /api/approvals/pending` 실행 | seconds_until_expiry 값 확인 | Low |
| CLI display 함수 수정 | 내부 용어를 `seconds_until_expiry`로 통합 | 남은 시간 정확히 표시 | Low |
| 통합 테스트 추가 | test_approval_workflow.py에 시간 검증 추가 | seconds_until_expiry > 0 검증 | Medium |
| 수동 확인 | API + CLI 실행하여 실제 시간 표시 확인 | "Expires in: 4m 40s" (0s 아님) | Low |

**수정 위치**:
- `security_admin.py:394`: `req.get("seconds_until_expiry", 0)`을 사용하도록 수정
- `approval_cli.py:207`: 내부 딕셔너리 키를 `seconds_until_expiry`로 노출

### Phase 4: Priority 3 - 테스트 실행 및 증거 문서화 (1 hour)

| Task | Description | DoD | Risk |
|------|-------------|-----|------|
| pytest 실행 | `cd services/mcp-server && pytest tests/test_approval_workflow.py -v` | 10/10 통과 | Low |
| 로그 저장 | pytest 결과를 `docs/progress/v1/APPROVAL_WORKFLOW_TEST_RESULTS.log`에 저장 | 파일 생성 확인 | Low |
| 문서 업데이트 | fb_18.md (존재 시) 또는 IMPLEMENTATION_SUMMARY.md에 테스트 명령 추가 | 테스트 실행 명령 명시 | Low |
| 스냅샷 생성 | 테스트 통과율, 실행 시간 요약 | "10/10 passed (100%)" 기록 | Low |

**실행 명령**:
```bash
cd services/mcp-server
pytest tests/test_approval_workflow.py -v --tb=short > ../../docs/progress/v1/APPROVAL_WORKFLOW_TEST_RESULTS.log 2>&1
```

### Phase 5: 문서 업데이트 및 회귀 테스트 (1 hour)

| Task | Description | DoD | Risk |
|------|-------------|-----|------|
| CLAUDE.md 업데이트 | 통합 테스트 증거 링크 추가 | APPROVAL_WORKFLOW_TEST_RESULTS.log 참조 | Low |
| IMPLEMENTATION_SUMMARY.md 업데이트 | 최신 CLI 사용법 반영 | list/approve/reject 예제 추가 | Low |
| RBAC_GUIDE.md 예제 확인 | 모든 CLI 예제가 실제 동작하는지 검증 | 문서대로 실행 성공 | Low |
| 회귀 테스트 | pytest + 수동 시나리오 (V2-V5) 재현 | 모든 시나리오 통과 | Medium |
| 최종 검토 | 문서-코드 정합성 재확인 | 모든 acceptance criteria 충족 | Low |

---

## Step 5: Risk Assessment & Mitigation

### High Risk Items
| Risk | Impact | Probability | Mitigation Strategy |
|------|--------|-------------|---------------------|
| CLI 변경으로 기존 스크립트 호환성 문제 | Medium | Low | argparse subparsers 사용, 인자 없을 시 기존 interactive mode 유지 |
| API가 `seconds_until_expiry` 키를 읽지 못함 | High | Low | view 정의 확인 후 API/CLI 모두 동일 키 사용 |
| 통합 테스트 실패 | High | Medium | 변경 전 baseline 테스트 실행, 단계별 검증 |

### Technical Challenges
**예상 기술적 난점**:
1. **pending_approvals view 정의 확인**
   - 해결: `services/mcp-server/scripts/security_schema.sql` 또는 `approval_schema.sql` 확인
   - DB에서 `PRAGMA table_info(pending_approvals)`로 `seconds_until_expiry` 컬럼 존재 확인

2. **CLI와 API 간 인증 메커니즘 차이**
   - CLI는 DB 직접 접근, API는 HTTP 헤더 인증
   - 해결: CLI는 계속 DB 직접 접근 유지 (운영자 도구이므로 안전)

3. **테스트 환경 설정**
   - Docker MCP 서버 실행 필요
   - 해결: `make up-p3` 또는 `docker compose -f docker/compose.p3.yml up -d`

### Rollback Plan
**롤백 시나리오**:
- **CLI 변경 실패** → Git revert, 기존 대화형 모드만 사용
- **API 응답 변경 문제** → 두 필드 모두 반환 (backwards compatibility)
- **테스트 실패** → Phase별 커밋으로 부분 롤백 가능

---

## Step 6: Resource Requirements

### Human Resources
- **개발자**: 1명 (Python, FastAPI, SQLite 경험)
- **리뷰어**: 1명 (보안 워크플로우 이해 필요)
- **QA**: 셀프 테스트 (pytest + 수동 시나리오)

### Technical Resources
- **개발 도구**: Python 3.11+, pytest, aiosqlite, rich
- **테스트 환경**: Docker Compose (Phase 3 스택)
- **데이터베이스**: `/mnt/e/ai-data/sqlite/security.db`

### Time Estimation
- **Phase 1 (준비)**: 0.5 hours
- **Phase 2 (CLI 구현)**: 2-3 hours
- **Phase 3 (API 필드)**: 1-2 hours
- **Phase 4 (테스트)**: 1 hour
- **Phase 5 (문서)**: 1 hour
- **버퍼**: 1 hour (20%)

**총 예상 시간**: **6-8 hours** (1일 작업)
**완료 목표일**: 2025-10-24

---

## Step 7: Quality Assurance Plan

### Test Strategy
**테스트 레벨**:
- **Unit Tests**: 각 하위 명령 개별 테스트 (선택적)
- **Integration Tests**: 현재 10개 시나리오 + 시간 검증 1개 추가
- **E2E Tests**: 문서 예제 재현 (수동)

### Test Cases

**1. CLI 하위 명령 테스트**
```bash
# TC1: List 명령
python scripts/approval_cli.py list
# Expected: Table with pending requests, seconds_until_expiry > 0

# TC2: Approve 명령
python scripts/approval_cli.py approve <request_id> --reason "Security team approval"
# Expected: "✓ Approved successfully"

# TC3: Reject 명령
python scripts/approval_cli.py reject <request_id> --reason "Policy violation"
# Expected: "✓ Rejected successfully"

# TC4: 기존 대화형 모드
python scripts/approval_cli.py
# Expected: Interactive panel displayed

# TC5: Help 출력
python scripts/approval_cli.py --help
# Expected: list, approve, reject subcommands shown
```

**2. API 필드 검증 테스트**
```bash
# TC6: API 응답 확인
curl http://localhost:8020/api/approvals/pending | jq '.pending_approvals[0]'
# Expected: {"request_id": "...", "seconds_until_expiry": 280, ...}

# TC7: Status 엔드포인트
curl http://localhost:8020/api/approvals/<id>/status | jq '.seconds_until_expiry'
# Expected: Positive integer (not 0)
```

**3. 통합 테스트 (pytest)**
```python
# TC8: New test case in test_approval_workflow.py
async def test_seconds_until_expiry_accuracy(test_db):
    """Test that seconds_until_expiry reflects actual remaining time"""
    db = test_db
    request_id = await create_approval_request(...)

    # Initial read
    initial = await db.list_pending_approvals()
    remaining = next((r for r in initial if r["request_id"] == request_id), None)
    assert remaining is not None
    assert remaining["seconds_until_expiry"] > 290  # Almost full 5 minutes

    # Simulate elapsed time by adjusting expires_at directly
    async with db.get_connection() as conn:
        await conn.execute(
            "UPDATE approval_requests SET expires_at = datetime(expires_at, '-30 seconds') WHERE request_id = ?",
            (request_id,),
        )
        await conn.commit()

    # Re-read and ensure countdown decreased without waiting on real time
    updated = await db.list_pending_approvals()
    remaining_now = next((r for r in updated if r["request_id"] == request_id), None)
    assert remaining_now is not None
    assert remaining_now["seconds_until_expiry"] < remaining["seconds_until_expiry"]
    assert remaining_now["seconds_until_expiry"] > 0
```

### Performance Criteria
- **CLI 응답시간**: < 1초 (list 명령)
- **API 응답시간**: < 100ms (pending 엔드포인트)
- **테스트 실행시간**: < 10초 (10개 통합 테스트)

---

## Step 8: Communication Plan

### Status Updates
- **일일 진행**: Todo 리스트 업데이트
- **Phase 완료**: GitHub Issue #36 댓글 추가
- **최종 완료**: PR 생성 및 리뷰 요청

### Stakeholder Notification
- **프로젝트**: Issue #36 완료 후 Production Readiness 마일스톤 업데이트
- **문서**: CLAUDE.md에 "Issue #36 완료" 기록

---

## 📋 User Review Checklist

**다음 항목들을 검토해주세요:**

### Planning Review
- [x] **이슈 분석이 정확한가요?**
  - 3가지 Priority 모두 명확히 식별됨
  - 문제 원인 (CLI 구조, API 필드 매핑, 테스트 증거) 정확히 파악됨

- [x] **선택한 해결 방안이 적절한가요?**
  - Option 1 (CLI 하위 명령 + API 필드 통일)이 프로덕션 검증 목적에 부합
  - Backwards compatibility 유지

- [x] **구현 계획이 현실적인가요?**
  - 5개 Phase로 세분화, 각 Phase별 DoD 명확
  - 의존성 순서 올바름 (준비 → CLI → API → 테스트 → 문서)

### Resource Review
- [x] **시간 추정이 합리적인가요?**
  - 6-8시간 (1일 작업), 20% 버퍼 포함
  - 각 Phase별 시간 분배 적절

- [x] **필요한 리소스가 확보 가능한가요?**
  - Python/FastAPI 개발 환경 ✅
  - Docker MCP 서버 ✅
  - Security DB 접근 ✅

### Risk Review
- [x] **위험 요소가 충분히 식별되었나요?**
  - CLI 호환성, DB view 정의, 테스트 실패 시나리오 모두 고려
  - 각 위험에 대한 구체적 대응 방안 제시

- [x] **롤백 계획이 현실적인가요?**
  - Git revert 가능, Phase별 커밋 전략
  - Backwards compatibility 유지로 롤백 리스크 최소화

### Quality Review
- [x] **테스트 전략이 충분한가요?**
  - 10개 기존 통합 테스트 + 1개 신규 (시간 검증)
  - 문서 예제 재현 테스트 (E2E)
  - API 수동 검증 포함

---

## 🚀 Next Steps

**검토 완료 후 진행할 작업:**

1. ✅ **Plan Approval**: 계획 검토 완료
2. **Implementation Start**: Priority 1부터 구현 시작
   - Phase 1: 환경 검증
   - Phase 2: CLI 하위 명령 구현
   - Phase 3: API 필드 통일
   - Phase 4: 테스트 실행
   - Phase 5: 문서 업데이트
3. **Issue Update**: 각 Phase 완료 시 GitHub Issue #36에 댓글 추가
4. **PR Creation**: 모든 작업 완료 후 PR 생성
5. **Final Verification**: 프로덕션 검증 체크리스트 확인

---

## 💡 피드백 요청

이 계획에 대해 다음 사항을 확인해주세요:

1. **우선순위 조정이 필요한가요?**
   - 현재: Priority 1 (CLI) → Priority 2 (API) → Priority 3 (테스트)
   - 다른 순서가 더 적절한가요?

2. **추가로 고려해야 할 사항이 있나요?**
   - DB view 정의 확인이 먼저 필요할까요?
   - 특정 엣지 케이스 테스트가 필요한가요?

3. **바로 구현을 시작할까요?**
   - 승인하시면 Phase 1부터 시작하겠습니다.
   - 추가 조사가 필요한 부분이 있다면 알려주세요.

**현재 상태**: 계획 수립 완료, 구현 준비 완료 ✅
